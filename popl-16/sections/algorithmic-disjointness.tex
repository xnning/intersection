\section{Algorithmic Disjointness}

As promised, in this section we present the set of rules for determining whether
two types are disjoint, and more importantly, how to derive them from the
definition we have in the previous sections. The derived set of rules for
disjointness is proved to be sound and complete with respect to the definition.

\subsection{Derivation}

For any two types $A$ and $B$, we can denote all their common
supertypes by $\commonsuper(A,B)$ and all their common subtypes by
$\commonsub(A,B)$. For example, since $\tyint$ and $\tychar$ shares no common
supertype,  $\commonsuper(\integer,\character)$ is empty.

\paragraph{Notation} We will use $\commonsub(A_1,A_3) \to \commonsuper(A_2,A_4)$
as a shorthand for $B_1 \to B_2$, where $B_1 \in \commonsub(A_1,A_3)$ and $B_2
\in \commonsuper(A_2,A_4)$, and the same for all other constructors of types.

Recall that we say two types $A$ and $B$ are disjoint if they do not share a
common supertype. Therefore, determining if two types $A$ and $B$ are disjoint
is the same as determining if $\commonsuper(A,B)$ is empty.

\paragraph{Determining disjointness of functions} Now let's dive into the case
where both $A$ and $B$ are functions and consider how to compute
$\commonsuper(A_1 \to A_2, B_1 \to B_2)$. By the subtyping rules, the supertype
of a function must also be a function. Let $C_1 \to C_2$ be a common supertype
of $A_1 \to A_2$ and $B_1 \to B_2$. Then it must satisfy the following:
\begin{mathpar}
  \inferrule* [right=SubFun]
    {C_1 \subtype A_1 \\ A_2 \subtype C_2}
    {A_1 \to A_2 \subtype C_1 \to C_2}

  \inferrule* [right=SubFun]
    {C_1 \subtype B_1 \\ B_2 \subtype C_2}
    {B_1 \to B_2 \subtype C_1 \to C_2}
\end{mathpar}
From which we see that $C_1$ is a common subtype of $A_1$ and $B_1$ and that
$C_2$ is a common supertype of $A_2$ and $B_2$. Therefore, we can wrtie:
\[ \commonsuper(A_1 \to A_2, B_1 \to B_2) \ = \ \commonsub(A_1,B_1) \to \commonsuper(A_2,B_2) \]
$\commonsub(A_1,B_1) \to \commonsuper(A_2,B_2)$ is not empty if an only if both
$\commonsub(A_1,B_1)$ and $\commonsuper(A_2,B_2)$ is nonempty. However, note
that with intersection types, $\commonsub(A_1,B_1)$ is always nonempty because
$A_1 \inter B_1$ belongs to $\commonsub(A_1,B_1)$. Therefore, the problem of
determining if $\commonsuper(A_1 \to A_2, B_1 \to B_2)$ is empty reduces to the
problem of determining if $\commonsuper(B_1 \to B_2)$ is empty, which is, by
definition, if $B_1$ and $B_2$ are disjoint. Finally, we have derived a rule for
functions:
\begin{mathpar}
  \inferrule* [right=DisjointFun]
    {\isdisjoint \Gamma {B_1} {B_2}}
    {\isdisjoint \Gamma {A_1 \to A_2} {B_1 \to B_2}}
\end{mathpar}

The analysis needed for determining if types with other constructors are
disjoint is similar. Below are the major results of the recursive definitions for
$\commonsuper$:
\begin{align*}
  \commonsuper(A_1 \to A_2, B_1 \to B_2) &= \commonsub(A_1,B_1) \to \commonsuper(A_2,B_2) \\
  \commonsuper({A_1 \inter A_2, B})      &= \commonsuper(A_1, B) \cup \commonsuper(A_1,B) \\
  \commonsuper({A, B_1 \inter B_2})      &= \commonsuper(A, B_1) \cup \commonsuper(A,B_2)
\end{align*}\george{Missing the forall case}

\subsection{Rules}

The rules for the disjointness judgement are shown in
Figure~\ref{fig:disjointness}. The judgement says two types $A$ and $B$ are
disjoint in a context $\Gamma$. Two atomic types with different shapes (except
for the variable) are considered disjoint, which is factored out to the atomic
disjointness rules. The \rulelabel{DisjointInter1} and
\rulelabel{DisjointInter2} inductively distribute the relation itself over the
intersection constructor ($\inter$). \rulelabel{DisjointFun} is quite
interesting, because it says two function types are disjoint as long as their
return types are disjoint (regardless of their parameter types).

\begin{figure}
  \begin{mathpar}
    \framebox{$ \isdisjoint \Gamma A B$} \\

    \disjointvar

    \inferrule* [right=DisjointSym]
          {\alpha * A \in \Gamma}
          {\isdisjoint \Gamma A \alpha}

    \disjointinterleft

    \disjointinterright

    \disjointfun

    \disjointforall

    \disjointatomic

\framebox{$ A \not\sim B$} \\

\inferrule* [right=NotSimBot1]
      {}
      {\bot \not\sim A \to B}

\inferrule* [right=NotSimBot2]
      {}
      {\bot \not\sim \for {\alpha * B} A}

\inferrule* [right=NotSimFunForall]
      {}
      {A \to B \not\sim \for {\alpha * B} A}

\inferrule* [right=NotSimFunForall]
      {B \not\sim A}
      {A \not\sim B}

  \end{mathpar}

  \label{fig:disjointness}
  \caption{Algorithmic Disjointness.}
\end{figure}

\begin{lemma}{Symmetry of disjointness} \label{symmetry-of-disjointness}
  If $\isdisjoint \Gamma A B$, then $\isdisjoint \Gamma B A$.
\end{lemma}

\subsection{Metatheory}

The algorithmic rules for disjointness is sound and complete.

\begin{theorem} \label{disjoint-intersect}
  If $\isdisjoint \Gamma A C$ and $\isdisjoint \Gamma B C$,
  then $\isdisjoint \Gamma {A \inter B} {C}$.
\end{theorem}

\begin{lemma} \label{common-supertype}
  If $A_1 \to A_2 \subtype D$ and $B_1 \to B_2 \subtype D$,
  then there exists a $C$ such that $A_2 \subtype C$ and $B_2 \subtype C$.
\end{lemma}

\begin{theorem}[Soundness]
  For any two types $A$, $B$, $\isdisjointi \Gamma A B$ implies $\isdisjoint \Gamma A B$.
\end{theorem}
