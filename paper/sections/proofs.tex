\section{Proofs}

\paragraph{Notation.} We present our proofs in two-column style: on the left are
the intermediate results and on the right are the justification (for the
previous intermediate result to reach the corresponding left-hand side).

\subsection{Elaboration}

\begin{lemma}[\rulelabelsub~rules produce type-correct coercion] \label{lemma:sub-correct}
  If $ \tau_1 \subtype \tau_2 \yields C $, then $ \judget \epsilon C {\im {\tau_1} \to \im {\tau_2}} $.
\end{lemma}

\begin{proof}
  By structural induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubvar &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judget {\epsilon} {\lam x {\im \alpha} x} {\alpha \to \alpha} $ & By $ \rulelabeltvar $ and $ \rulelabeltlam $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubfun &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \tau_3 \subtype \tau_1 \yields {C_1} $ & Premise \\
      & $ \judget \epsilon {C_1} {\im {\tau_3} \to \im {\tau_1}} $ & By i.h. \\
      & $ \judget \epsilon {C_2} {\im {\tau_2} \to \im {\tau_4}} $ & Similar to the above \\
      \george{TODO} &
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubforall &
    \end{flalign*}

    \begin{tabular}{rll}
      & \george{TODO} &
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesuband &
    \end{flalign*}

    \begin{tabular}{rll}
      & \george{TODO} &
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubandleft &
    \end{flalign*}

    \begin{tabular}{rll}
      & \george{TODO} &
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubandright &
    \end{flalign*}

    By symmetry with the above case. \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulesubrec &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \tau_1 \subtype \tau_2 \yields C $ & Premise \\
      (a) & $ \judget \epsilon C {\im {\tau_1} \to \im {\tau_2}} $ & By i.h. \\
      & $ \judget {\epsilon, x \hast \im {\recty l {\tau_1}}} x {\im {\recty l {\tau_1}}} $ & By $ \rulelabeltvar $ \\
      & $ \judget {\epsilon, x \hast \im {\recty l {\tau_1}}} x {\im {\tau_1}} $ & By the definition of $ \im \cdot $ \\
      & $ \judget {\epsilon, x \hast \im {\recty l {\tau_1}}} {\app C x} {\im {\tau_2}} $ & By $ \rulelabeltapp $ and (a) \\
      & $ \judget {\epsilon, x \hast \im {\recty l {\tau_1}}} {\app C x} {\im {\recty l {\tau_2}}} $ & By the definition of $ \im \cdot $ \\
      & $ \judget \epsilon {\lam x {\im {\recty l {\tau_1}}} {\app C x}} {\im {\recty l {\tau_1}} \to \im {\recty l {\tau_2}}} $ & By $ \rulelabeltlam $ 
    \end{tabular} \\

  \end{itemize}

\end{proof}

\begin{lemma}[\rulelabelget~rules produce type-correct coercion] \label{lemma:get-correct}
  If $ \judgeget \tau l {\tau_1} \yields C $, then $ \judget \epsilon C {\im \tau \to \im {\tau_1}} $.
\end{lemma}

\begin{proof}
  By structural induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judget \epsilon {\lam x {\im {\recty l \tau}} x} {\im {\recty l \tau} \to \im {\recty l \tau}} $ & By $ \rulelabeltlam $ and $\rulelabeltvar$ \\
      & $ \judget \epsilon {\lam x {\im {\recty l \tau}} x} {\im {\recty l \tau} \to \im \tau} $ & By the definition of $ \im \cdot $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetleftelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judget {\epsilon, x \hast \im {\tau_1 \andop \tau_2}} x {\im {\tau_1 \andop \tau_2}} $ & By $ \rulelabeltvar $ \\
      & $ \judget {\epsilon, x \hast \im {\tau_1 \andop \tau_2}} x {\pair {\im {\tau_1}} {\im {\tau_2}}} $ & By the definition of $\im \cdot$ \\
      & $ \judget {\epsilon, x \hast \im {\tau_1 \andop \tau_2}} {\proj 1 x} {\im {\tau_1}} $ & By $\rulelabeltprojleft$ \\
      & $ \judget \epsilon C {\im {\tau_1} \to \im \tau} $ & By i.h. \\
      & $ \judget {\epsilon, x \hast \im {\tau_1 \andop \tau_2}} C {\im {\tau_1} \to \im \tau} $ & \george{What should this be called?} \\
      & $ \judget {\epsilon, x \hast \im {\tau_1 \andop \tau_2}} {\app C {(\proj 1 x)}} {\im \tau} $ & By $\rulelabeltapp$ \\
      & $ \judget \epsilon {\lam x {\im {\tau_1 \andop \tau_2}} {\app C {(\proj 1 x)}}} {\im {\tau_1 \andop \tau_2} \to \im \tau} $ & By $ \rulelabeltlam $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetrightelab &
    \end{flalign*}

    By symmetry with the above case. \\

\end{itemize}
\end{proof}


\begin{lemma}[\rulelabelres~rules produce type-correct coercion] \label{lemma:get-correct}
  If $ \judgeres \tau l {\tau_1} \yields C $, then $ \judget \epsilon C {\im \tau \to \im {\tau_1}} $.
\end{lemma}

\begin{proof}
  By structural induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \rulereselab &
    \end{flalign*}

    \begin{tabular}{rll}
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleresleftelab &
    \end{flalign*}

    \begin{tabular}{rll}
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleresrightelab &
    \end{flalign*}

    By symmetry with the above case. \\

\end{itemize}
\end{proof}


\begin{lemma}[\rulelabelput~rules produce type-correct coercion] \label{lemma:put-correct}
  If $ \judgeput \tau l {\tau_1 \yields E} {\tau_2} {\tau_3} \yields C $ and $
  \judget \Gamma E {\im {\tau_1}} $ for some $ \Gamma $, then
  $ \judget \Gamma C {\im \tau \to \im {\tau_2}} $.
\end{lemma}

\begin{proof}
  By structural induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judget \Gamma {\lam \_ {\im {\recty l \tau}} E} {\im {\recty l \tau}} \to \im {\tau_1} $ & By $ \rulelabeltlam $, $ \rulelabeltvar $, and the hypothesis
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputleftelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judget {\Gamma, x \hast \im {\tau_1 \andop \tau_2}} x {\im {\tau_1 \andop \tau_2}} $ & By $\rulelabeltvar$ \\
      & $ \judget {\Gamma, x \hast \im {\tau_1 \andop \tau_2}} x {\pair {\im {\tau_1}} {\im {\tau_2}}} $ & By the definition of $\im \cdot$ \\
      & $ \judget {\Gamma, x \hast \im {\tau_1 \andop \tau_2}} {\proj 1 x} {\im {\tau_1}} $ & By $\rulelabeltprojleft$ \\
      & $ \judget \Gamma C {\im {\tau_1} \to \im {\tau_3}} $ & By i.h. \\ 
      & $ \judget {\Gamma, x \hast \im {\tau_1 \andop \tau_2}} C {{\im {\tau_1}} \to \im {\tau_3}} $ & \george{Seems to need to assume $x$ fresh} \\ 
      & $ \judget {\Gamma, x \hast \im {\tau_1 \andop \tau_2}} {\app C {(\proj 1 x)}} {\im {\tau_3}} $ & By $\rulelabeltapp$ \\
      & $ \judget \Gamma {\lam x {\im {\tau_1 \andop \tau_2}} {\app C {(\proj 1 x)}}} {\im {\tau_1 \andop \tau_2} \to \im {\tau_3}} $ & By $\rulelabeltlam$
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputrightelab &
    \end{flalign*}

    By symmetry with the above case. \\

  \end{itemize}
\end{proof}

\begin{lemma}[Preservation of well-formedness under type translation] \label{lemma:preserve-wf}
  If $ \judgeewf \gamma \tau $, then $ \judgetwf {\im \gamma} {\im \tau} $.
\end{lemma}

\begin{proof}
  By structural induction of the derivation. The only case to consider is $ \rulelabelewf $.

  \begin{itemize}

  \item \textbf{Case}

    \begin{flalign*}
      & \ruleewf &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \ftv \tau \in \gamma $ & Premise \\
      & $ \ftv {\im \tau} \in \im \gamma $ & By the definition of $ \im \cdot $ \\
      & $ \judgetwf {\im \gamma} {\im \tau} $ & By $ \rulelabeltwf $
    \end{tabular} \\

  \end{itemize}
\end{proof}

\begin{theorem}[Type-preserving translation]
  If $ \judgee \gamma e \tau \yields E $, then $ \judget {\im \gamma} E {\im \tau} $.
\end{theorem}

\begin{proof}
  By structural induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleevarelab &
    \end{flalign*}

    \begin{tabular}{rll}
     & $ (x,\tau) \in \gamma $ & Premise \\
     & $ (x,\im \tau) \in \im \gamma $ & \\
     & $ \judget {\im \gamma} x {\im \tau} $ & By $ \rulelabeltvar $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleelamelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judgee {\gamma, x \hast \tau} e {\tau_1} \yields E $ & Premise \\
      & $ \judget {\im {\gamma, x \hast \tau}} E {\im {\tau_1}} $ & By i.h. \\
      & $ \judget {\im \gamma, x \hast \im \tau} E {\im {\tau_1}} $ & \\
      & $ \judget {\im \gamma} {\lam x {\im \tau} E} {\im \tau \to \im {\tau_1}} $ & By $ \rulelabeltlam $ \\
      & $ \judget {\im \gamma} {\lam x {\im \tau} E} {\im {\tau \to \tau_1}} $ & By the definition of $ \im \cdot $ 
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleeappelab &
    \end{flalign*}

    \begin{tabular}{rll}
     & $ \judgee \gamma {e_1} {\tau_1 \to \tau_2} \yields {E_1} $  & Premise \\
     & $ \judget {\im \gamma} {E_1} {\im {\tau_1 \to \tau_2}} $ & By i.h. \\
     & $ \judgee \gamma {e_2} {\tau_3} \yields {E_2} $ & Premise \\
     & $ \judget {\im \gamma} {E_2} {\im {\tau_3}} $ & By i.h. \\
     & $ \tau_3 \subtype \tau_1 \yields C $ & Premise \\
     & $ \judget \epsilon C {\im {\tau_3} \to \im {\tau_1}} $ & \george{one lemma about coercion} \\
     & $ \judget {\im \gamma} {\app {E_1} {(\app C E_2)}} {\im {\tau_2}} $ & By $ \rulelabeltapp $ and the definition of $ \im \cdot $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleeblamelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judgee {\gamma, \alpha} e \tau \yields E $ & Premise \\
      & $ \judget {\im {\gamma, \alpha}} E {\im \tau} $ & By i.h. \\
      & $ \judget {\im \gamma, \alpha} E {\im \tau} $ &  \\
      & $ \judget {\im \gamma} {\blam \alpha E} {\for \alpha {\im \tau}} $ & By $ \rulelabeltblam $ \\
      & $ \judget {\im \gamma} {\blam \alpha E} {\im {\for \alpha \tau}} $ & By the definition of $ \im \cdot $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleetappelab &
    \end{flalign*}

    \begin{tabular}{rll}
     & $ \judgee \gamma e {\for \alpha \tau_1} \yields E $ & Premise \\
     & $ \judget {\im \gamma} E {\im {\for \alpha \tau_1}} $ & By i.h. \\
     & $ \judget {\im \gamma} E {\for \alpha \im {\tau_1}} $ & By the definition of $ \im \cdot $ \\
     & $ \judgeewf \gamma \tau $ & Premise \\
     & $ \judgetwf {\im \gamma} {\im \tau} $ & By Lemma~\ref{lemma:preserve-wf} \\
     & $ \judget \gamma {\tapp E {\im \tau}} {\subst {\im \tau} \alpha {\im {\tau_1}}} $ & By $ \rulelabelttapp $ \\
     & $ \judget \gamma {\tapp E {\im \tau}} {\im {\subst \tau \alpha {\tau_1}}} $ &  
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleemergeelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judgee \gamma {e_1} {\tau_1} \yields {E_1} $ & Premise \\
      & $ \judget {\im \gamma} {E_1} {\im {\tau_1}} $ & By i.h. \\
      & $ \judget {\im \gamma} {E_2} {\im {\tau_2}} $ & Similar to the above \\
      & $ \judget {\im \gamma} {\pair {E_1} {E_2}} {\pair {\im {\tau_1}} {\im {\tau_2}}} $ & By $ \rulelabeltpair $ \\
      & $ \judget {\im \gamma} {\pair {E_1} {E_2}} {\im {\tau_1 \andop \tau_2}} $ & By the definition of $ \im \cdot $ 
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleerecconelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judgee \gamma e \tau \yields E $ & Premise \\
      & $ \judget {\im \gamma} E {\im \tau} $ & By i.h. \\
      & $ \judget {\im \gamma} E {\im {\recty l \tau}} $ & By the definition of $ \im \cdot $ 
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleerecselelab &
    \end{flalign*}

    \begin{tabular}{rll}
     & $ \judgeget \tau l {\tau_1} \yields C $ & Premise \\
     & $ \judget \epsilon C {\im \tau \to \im {\tau_1}} $ & By Lemma~\ref{lemma:get-correct} \\
     & $ \judget {\im \gamma} C {\im \tau \to \im {\tau_1}} $ &  \\
     & $ \judgee \gamma e \tau \yields E $ & Premise \\
     & $ \judget {\im \gamma} E {\im \tau} $ & By i.h. \\
     & $ \judget {\im \gamma} {\app C E} {\im {\tau_1}} $ & By $ \rulelabeltapp $
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleerecupdelab &
    \end{flalign*}

    \begin{tabular}{rll}
      & $ \judgee \gamma {e_1} {\tau_1} \yields {E_1} $ & Premise \\
      & $ \judget {\im \gamma} {E_1} {\im {\tau_1}} $ & By i.h. \\
      & $ \judgeput \tau l {\tau_1 \yields {E_1}} {\tau_2} {\tau_3} \yields C $ & Premise \\
      & $ \judget {\im \gamma} C {\im \tau \to \im {\tau_2}} $ & By Lemma~\ref{lemma:put-correct} \\
      & $ \judgee \gamma e \tau \yields E $ & Premise \\
      & $ \judget {\im \gamma} E {\im \tau} $ & By i.h. \\
      & $ \judget {\im \gamma} {\app C E} {\im {\tau_2}} $ & By $ \rulelabeltapp $
    \end{tabular} \\

  \end{itemize}
\end{proof}

