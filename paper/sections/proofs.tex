\section{Proofs}

\begin{proof}
By structural induction on the types and the corresponding inference rule. \\

\rulename{SubVar}

\rulename{SubFun}

\rulename{SubForall}

\rulename{SubAnd1}

\rulename{SubAnd2}

\rulename{SubAnd3}

\rulename{SubRcd}

\end{proof}

\begin{lemma}
  If $$ \Gamma \turnsget \ty ; l = C ; \ty_1 $$
  then $$ \image \Gamma \turns C : \image \ty \to \image {\ty_1} $$
\end{lemma}

\begin{proof}
By structural induction on the type and the corresponding inference rule. \\

\rulename{Get-Base} $ \Gamma \turnsget \recordtype l \ty ; l = \idmono {\image {\recordtype l \ty})} ; \ty $ \\

By the induction hypothesis
$$ \image \Gamma \turns \idmono {\image {\recordtype l \ty}} : \image {\recordtype l \ty} \to \image \ty $$

\rulename{Get-Left} \\
\rulename{Get-Right} \\

\end{proof}

\begin{lemma}
  If $$ \Gamma \turnsput \ty ; l ; E = C ; \ty_1 $$
  then $$ \image \Gamma \turns C : \image \ty \to \image \ty $$
\end{lemma}

\begin{proof}
By structural induction on the type and the corresponding inference rule. \\

\rulename{Put-Base} \\
\rulename{Put-Left} \\
\rulename{Put-Right} \\
\end{proof}

\begin{lemma} \label{preserve-wf}
  If   $$ \Gamma \turns \ty $$
  then $$ \image \Gamma \turns \image \ty $$
\end{lemma}

\begin{proof}
Since $$ \Gamma \turns \ty $$
It follows from \rulename{FI-WF} that
  $$ \ftv \ty  \subseteq \ftv {\Gamma} $$
And hence
  $$ \ftv {\image \ty} \subseteq \ftv {\image \Gamma} $$
By \rulename{F-WF} we have
  $$ \Gamma \turns \ty $$
\end{proof}

\begin{theorem}[Type preserving translation]
  If   $$ \Gamma \turns e : \ty \yields E  $$
  then $$ \image \Gamma \turns E : \image \ty $$
\end{theorem}

\begin{proof}
By structural induction on the expression and the corresponding inference rule. \\

\rulename{TrVar} $ \Gamma \turns x : \ty \yields x $ \\

It follows from \rulename{TrVar} that
  $$ (x : t) \in \Gamma $$
Based on the definition of $ \image \cdot $,
  $$ (x : \image t) \in \image \Gamma $$
Thus we have by \rulename{F-Var} that
  $$ \image \Gamma \turns x : \image \ty $$

\rulename{TrAbs} $ \Gamma \turns \lambda (x : \ty_1). e : \ty_1 \to \ty_2 \yields {\absty x {\image {\ty_1}} E} $ \\

It follows from \rulename{TrAbs} that
  $$ \Gamma, x : \ty_1 \turns e : \ty_2 \yields E $$
And by the induction hypothesis that
  $$ \image \Gamma, x : \image {\ty_1} \turns E : \image {\ty_2} $$
By \rulename{TrAbs} we also have
  $$ \Gamma \turns \ty_1 $$
It follows from Lemma \ref{preserve-wf} that
  $$ \image \Gamma \turns \image {\ty_1} $$
Hence by \rulename{F-Abs} and the definition of $ \image \cdot $ we have
  $$ \image \Gamma \turns \absty x {\image {\ty_1}} E : \image {\ty_1 \to \ty_2} $$

\rulename{(TrApp)} $ \Gamma \turns \app {e_1} {e_2} : \ty_2 \yields {E_1 (\app C {E_2})} $ \\

From \rulename{(TrApp)} we have
  $$ \Gamma \turns \ty_3 <: \ty_1 \yields C $$
Applying Lemma \ref{type-coerce} to the above we have
  $$ \image \Gamma \turns C : \image {\ty_3} \to \image {\ty_1} $$
Also from \rulename{(TrApp)} and the induction hypothesis
  $$ \image \Gamma \turns E_1 : \image {\ty_1} \to \image {\ty_2} $$
Also from \rulename{(TrApp)} and the induction hypothesis
  $$ \image \Gamma \turns E_2 : \image {\ty_3} $$
Assembling those parts using \rulename{(F-App)} we come to
  $$ \image \Gamma \turns E_1 (\app C {E_2}) : \image {\ty_2} $$
\end{proof}

\rulename{TrTAbs} $ \Gamma \turns \Lambda \alpha. e : \forall \alpha. \ty \yields {\forall \alpha. E} $ \\

From \rulename{TrTAbs} we have
  $$ \Gamma \turns e : \ty \yields E $$
By the induction hypothesis we have
  $$ \image \Gamma \turns E : \image \ty $$
Thus by \rulename{F-TAbs} and the definition of $ \image \cdot $
  $$ \Gamma \turns \Lambda \alpha. E : \image {\forall \alpha. \ty} $$


\rulename{TrTAp} $ \Gamma \turns e \; \ty  : [\alpha := t] \ty_1 \yields {E \; \image \ty} $ \\

From \rulename{TrTApp} we have
  $$ \Gamma \turns e : \forall \alpha. \ty_1 \yields E $$
And by the induction hypothesis that
  $$ \image \Gamma \turns E : \forall \alpha. \image {\ty_1} $$
Also from \rulename{TrTApp} and Lemma \ref{preserve-wf} we have
  $$ \image \Gamma \turns \image \ty $$
Then by \rulename{F-TApp} that
  $$ \image \Gamma \turns E \; \image \ty : [\alpha := \image \ty ] \image {\ty_1} $$
Therefore
  $$ \image \Gamma \turns E \; \image \ty : \image {[\alpha := \ty ] \image {\ty_1}} $$

% \rulename{(TrMerge)} $ \Gamma \turns e_1 \merge e_2 : \ty_1 \& \ty_2 % % \yields {\tupled {E1, E2} $ \\

From \rulename{(TrMerge)} and the induction hypothesis we have
  $$ \image \Gamma \turns E_1 : \image {\ty_1} $$
and
  $$ \image \Gamma \turns E_2 : \image {\ty_2} $$
Hence by \rulename{F-Pair}
  $$ \image \Gamma \turns \tupled {E_1, E_2} : \tupled {\image {\ty_1}, \image {\ty_2}} $$
Hence by the definition of $ \image \cdot $
  $$ \image \Gamma \turns \tupled {E_1, E_2} : \image {\ty_1 \& \ty_2} $$

\rulename{TrRcdIntro} $ \Gamma \turns \recordintro l e : \recordtype l \ty \yields E $ \\

From \rulename{TrRcdIntro} we have
  $$ \Gamma \turns e : \ty \yields E $$
And by the induction hypothesis that
  $$ \image \Gamma \turns E : \image \ty $$
Thus by the definition of $ \image \cdot $
  $$ \image \Gamma \turns E : \image {\recordtype l \ty} $$

\rulename{TrRcdElim} $ \Gamma \turns e.l : \ty_1 \yields {\app C E} $ \\

From \rulename{TrRcdElim}
  $$ \Gamma \turns e : \ty \yields E $$
And by the induction hypothesis that
  $$ \image \Gamma \turns E : \image \ty $$
Also from \rulename{TrRcdEim}
  $$ \Gamma \turnsget e ; l = C ; \ty_1 $$
Applying Lemma \ref{type-get} to the above we have
  $$ \image \Gamma \turns C : \image \ty \to \image {\ty_1}  $$
Hence by \rulename{F-App} we have
  $$ \image \Gamma \turns \app C E : \image {\ty_1} $$

From \rulename{TrRcdUpd}
  $$ \Gamma \turns e : \ty \yields E $$
And by the induction hypothesis that
  $$ \image \Gamma \turns E : \image \ty $$
Also from \rulename{TrRcdUpd}
  $$ \Gamma \turnsput \ty ; l; E = C ; \ty_1 $$
Applying Lemma \ref{type-put} to the above we have
  $$ \image \Gamma \turns C : \image \ty \to \image \ty  $$
Hence by \rulename{F-App} we have
  $$ \image \Gamma \turns \app C E : \image \ty $$
