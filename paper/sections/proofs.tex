\section{Proofs}

\begin{proof}
By structural induction on the types and the corresponding inference rule. \\

\texttt{(SubVar)}

\texttt{(SubFun)}

\texttt{(SubForall)}

\texttt{(SubAnd1)}

\texttt{(SubAnd2)}

\texttt{(SubAnd3)}

\texttt{(SubRcd)}

\end{proof}

\begin{lemma}
  If $$ \Gamma \vdash_{get} t ; l = C ; t_1 $$
  then $$ |\Gamma| \vdash C : |t| \to |t_1| $$
\end{lemma}

\begin{proof}
By structural induction on the type and the corresponding inference rule. \\

\texttt{(Get-Base)} $ \Gamma \vdash_{get} \{ l : t \} ; l = \lambda (x : |\{ l : t \}|). x ; t $ \\

By the induction hypothesis
$$ |\Gamma| \vdash \lambda (x : |\{ l : t \}|). x : |\{ l : t \}| \to |t| $$

\texttt{(Get-Left)} \\
\texttt{(Get-Right)} \\

\end{proof}

\begin{lemma}
  If $$ \Gamma \vdash_{put} t ; l ; E = C ; t_1 $$
  then $$ |\Gamma| \vdash C : |t| \to |t| $$
\end{lemma}

\begin{proof}
By structural induction on the type and the corresponding inference rule. \\

\texttt{(Put-Base)} \\
\texttt{(Put-Left)} \\
\texttt{(Put-Right)} \\
\end{proof}

\begin{lemma} \label{preserve-wf}
  If   $$ \Gamma \vdash t $$
  then $$ |\Gamma| \vdash |t| $$
\end{lemma}

\begin{proof}
Since $$ \Gamma \vdash t $$
It follows from \texttt{(FI-WF)} that
  $$ \ftv{t} \subseteq \ftv{\Gamma} $$
And hence
  $$ \ftv{|t|} \subseteq \ftv{|\Gamma|} $$
By \texttt{(F-WF)} we have
  $$ \Gamma \vdash t $$
\end{proof}

\begin{theorem}[Type preserving translation]
  If   $$ \Gamma \vdash e : t \yields{E} $$
  then $$ |\Gamma| \vdash E : \left| t \right| $$
\end{theorem}

\begin{proof}
By structural induction on the expression and the corresponding inference rule. \\

\texttt{(TrVar)} $ \Gamma \vdash x : t \yields{x} $ \\

It follows from \texttt{(TrVar)} that
  $$ (x : t) \in \Gamma $$
Based on the definition of $ |\cdot| $,
  $$ (x : |t|) \in |\Gamma| $$
Thus we have by \texttt{(F-Var)} that
  $$ |\Gamma| \vdash x : |t| $$

\texttt{(TrAbs)} $ \Gamma \vdash \lambda (x : t_1). e : t_1 \to t_2 \yields{\lambda x : |t_1|. E} $ \\

It follows from \texttt{(TrAbs)} that
  $$ \Gamma, x : t_1 \vdash e : t_2 \yields{E} $$
And by the induction hypothesis that
  $$ |\Gamma|, x : |t_1| \vdash E : |t_2| $$
By \texttt{(TrAbs)} we also have
  $$ \Gamma \vdash t_1 $$
It follows from Lemma \ref{preserve-wf} that
  $$ |\Gamma| \vdash |t_1| $$
Hence by \texttt{(F-Abs)} and the definition of $|\cdot|$ we have
  $$ |\Gamma| \vdash \lambda x : |t_1|. E : |t_1 \to t_2| $$

\texttt{(TrApp)} $ \Gamma \vdash e_1 e_2 : t_2 \yields{E_1 (C E_2)} $ \\

From \texttt{(TrApp)} we have
  $$ \Gamma \vdash t_3 <: t_1 \yields{C} $$
Applying Lemma \ref{type-coerce} to the above we have
  $$ |\Gamma| \vdash C : |t_3| \to |t_1| $$
Also from \texttt{(TrApp)} and the induction hypothesis
  $$ |\Gamma| \vdash E_1 : |t_1| \to |t_2| $$
Also from \texttt{(TrApp)} and the induction hypothesis
  $$ |\Gamma| \vdash E_2 : |t_3| $$
Assembling those parts using \texttt{(F-App)} we come to
  $$ |\Gamma| \vdash E_1 (C E_2) : |t_2| $$
\end{proof}

\texttt{(TrTAbs)} $ \Gamma \vdash \Lambda \alpha. e : \forall \alpha. t \yields{\forall \alpha. E} $ \\

From \texttt{(TrTAbs)} we have
  $$ \Gamma \vdash e : t \yields{E} $$
By the induction hypothesis we have
  $$ |\Gamma| \vdash E : |t| $$
Thus by \texttt{(F-TAbs)} and the definition of $|\cdot|$
  $$ \Gamma \vdash \Lambda \alpha. E : |\forall \alpha. t| $$


\texttt{(TrTApp)} $ \Gamma \vdash e \; t  : [\alpha := t]t_1 \yields{E \; |t|} $ \\

From \texttt{(TrTApp)} we have
  $$ \Gamma \vdash e : \forall \alpha. t_1 \yields{E} $$
And by the induction hypothesis that
  $$ |\Gamma| \vdash E : \forall \alpha. |t_1| $$
Also from \texttt{(TrTApp)} and Lemma \ref{preserve-wf} we have
  $$ |\Gamma| \vdash |t| $$
Then by \texttt{(F-TApp)} that
  $$ |\Gamma| \vdash E \; |t| : [\alpha := |t| ]|t_1| $$
Therefore
  $$ |\Gamma| \vdash E \; |t| : | [\alpha := t ] | t_1 | | $$

% \texttt{(TrMerge)} $ \Gamma \vdash e_1 \merge e_2 : t_1 \& t_2 \yields{\langle E1, E2  \rangle}$ \\

From \texttt{(TrMerge)} and the induction hypothesis we have
  $$ |\Gamma| \vdash E_1 : |t_1| $$
and
  $$ |\Gamma| \vdash E_2 : |t_2| $$
Hence by \texttt{(F-Pair)}
  $$ |\Gamma| \vdash \langle E_1, E_2 \rangle : \langle |t_1|, |t_2| \rangle $$
Hence by the definition of $|\cdot|$
  $$ |\Gamma| \vdash \langle E_1, E_2 \rangle : |t_1 \& t_2| $$

\texttt{(TrRcdIntro)} $ \Gamma \vdash \{ l = e \} : \{ l : t \} \yields{E} $ \\

From \texttt{(TrRcdIntro)} we have
  $$ \Gamma \vdash e : t \yields{E} $$
And by the induction hypothesis that
  $$ |\Gamma| \vdash E : |t| $$
Thus by the definition of $|\cdot|$
  $$ |\Gamma| \vdash E : |\{ l : t \}| $$

\texttt{(TrRcdElim)} $ \Gamma \vdash e.l : t_1 \yields{C E} $ \\

From \texttt{(TrRcdElim)}
  $$ \Gamma \vdash e : t \yields{E} $$
And by the induction hypothesis that
  $$ |\Gamma| \vdash E : |t| $$
Also from \texttt{(TrRcdEim)}
  $$ \Gamma \vdash_{get} e ; l = C ; t_1 $$
Applying Lemma \ref{type-get} to the above we have
  $$ |\Gamma| \vdash C : |t| \to |t_1|  $$
Hence by \texttt{(F-App)} we have
  $$ |\Gamma| \vdash C E : |t_1| $$

% \texttt{(TrRcdUpd)} $ \Gamma \vdash \rcdupd{e}{l}{e_1} : t \yields{C E} $ \\

From \texttt{(TrRcdUpd)}
  $$ \Gamma \vdash e : t \yields{E} $$
And by the induction hypothesis that
  $$ |\Gamma| \vdash E : |t| $$
Also from \texttt{(TrRcdUpd)}
  $$ \Gamma \vdash_{put} t ; l; E = C ; t_1 $$
Applying Lemma \ref{type-put} to the above we have
  $$ |\Gamma| \vdash C : |t| \to |t|  $$
Hence by \texttt{(F-App)} we have
  $$ |\Gamma| \vdash C E : |t| $$
