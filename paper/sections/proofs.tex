\section{Proofs}

\begin{lemma}[\rulelabelget~rules produces type-correct coercion]
  If $ \judgeget \tau l {\tau_1} \yields C $, then $ \im \gamma \turns C :
  \im \tau \to \im {\tau_1} $ for any $\gamma$.
\end{lemma}

\begin{proof}
  By induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetelab &
    \end{flalign*}

    \begin{tabular}{ll}
      $ \Gamma \turns \Lam x {\im {\RecTy l \tau}} x : \im {\RecTy l \tau} \to \im {\RecTy l \tau} $ & By $\rulelabeltlam$ and $\rulelabeltvar$ \\
      $ \im \gamma \turns \Lam x {\im {\RecTy l \tau}} x : \im {\RecTy l \tau} \to \im \tau $ & By the definition of $\im \cdot$
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetleftelab &
    \end{flalign*}

    \begin{tabular}{ll}
      $\im \gamma, x \hast \im {\tau_1 \Intersect \tau_2} \turns x : \im {\tau_1 \Intersect \tau_2}$ & By $\rulelabeltvar$ \\
      $\im \gamma, x \hast \im {\tau_1 \Intersect \tau_2} \turns x : \Pair {\im {\tau_1}} {\im {\tau_2}}$ & By the definition of $\im \cdot$ \\
      $\im \gamma, x \hast \im {\tau_1 \Intersect \tau_2} \turns \Proj 1 x : \im {\tau_1}$ & By $\rulelabeltprojl$ \\
      $\im \gamma \turns C : \im {\tau_1} \to \im \tau$ & By i.h. \\
      $\im \gamma, x \hast \im {\tau_1 \Intersect \tau_2} \turns \App C (\Proj 1 x) : \im {\tau}$ & By $\rulelabeltapp$ \\
      $\im \gamma \turns \Lam x {\im {\tau_1 \Intersect \tau_2}} {C (\Proj 1 x)} : \im {\tau_1 \Intersect \tau_2} \to \im {\tau}$ & By $\rulelabeltlam$
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \rulegetrightelab &
    \end{flalign*}

    Symmetric with the above case. \\

\end{itemize}
\end{proof}


\begin{lemma}[\rulelabelput~rules produces type-correct coercion]
  If $ \judgeput \tau l {\tau_1 \yields E} {\tau_2} {\tau_3} \yields C $, then
  $ \im \gamma \turns C : \im \tau \to \im {\tau_2} $ for any $\gamma$.
\end{lemma}

\begin{proof}
  By induction of the derivation.

  \begin{itemize}

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputelab &
    \end{flalign*}

    \begin{tabular}{ll}
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputleftelab &
    \end{flalign*}

    \begin{tabular}{ll}
    \end{tabular} \\

  \item \textbf{Case}
    \begin{flalign*}
      & \ruleputrightelab &
    \end{flalign*}

    Symmetric with the above case. \\

\end{itemize}
\end{proof}



\begin{proof}
By structural induction on the types and the corresponding inference rule. \\

\rulename{SubVar}

\rulename{SubFun}

\rulename{SubForall}

\rulename{SubAnd1}

\rulename{SubAnd2}

\rulename{SubAnd3}

\rulename{SubRcd}

\end{proof}

\begin{lemma}
  If $$ \Gamma \turnsput \tau ; l ; E = C ; \tau_1 $$
  then $$ \im \Gamma \turns C : \im \tau \to \im \tau $$
\end{lemma}

\begin{proof}
By structural induction on the type and the corresponding inference rule. \\

\rulename{Put-Base} \\
\rulename{Put-Left} \\
\rulename{Put-Right} \\
\end{proof}

\begin{lemma} \label{preserve-wf}
  If   $$ \Gamma \turns \tau $$
  then $$ \im \Gamma \turns \im \tau $$
\end{lemma}

\begin{proof}
Since $$ \Gamma \turns \tau $$
It follows from \rulename{FI-WF} that
  $$ \ftv \tau  \subseteq \ftv {\Gamma} $$
And hence
  $$ \ftv {\im \tau} \subseteq \ftv {\im \Gamma} $$
By \rulename{F-WF} we have
  $$ \Gamma \turns \tau $$
\end{proof}

\begin{theorem}[Type preserving translation]
  If   $$ \Gamma \turns e : \tau \yields E  $$
  then $$ \im \Gamma \turns E : \im \tau $$
\end{theorem}

\begin{proof}
By structural induction on the expression and the corresponding inference rule. \\

\rulename{Var} $ \Gamma \turns x : \tau \yields x $ \\

It follows from \rulename{Var} that
  $$ (x : t) \in \Gamma $$
Based on the definition of $ \im \cdot $,
  $$ (x : \im t) \in \im \Gamma $$
Thus we have by \rulename{F-Var} that
  $$ \im \Gamma \turns x : \im \tau $$

\rulename{Abs} $ \Gamma \turns \lambda (x : \tau_1). e : \tau_1 \to \tau_2 \yields {\Lam x {\im {\tau_1}} E} $ \\

It follows from \rulename{Abs} that
  $$ \Gamma, x : \tau_1 \turns e : \tau_2 \yields E $$
And by the induction hypothesis that
  $$ \im \Gamma, x : \im {\tau_1} \turns E : \im {\tau_2} $$
By \rulename{Abs} we also have
  $$ \Gamma \turns \tau_1 $$
It follows from Lemma \ref{preserve-wf} that
  $$ \im \Gamma \turns \im {\tau_1} $$
Hence by \rulename{F-Abs} and the definition of $ \im \cdot $ we have
  $$ \im \Gamma \turns \Lam x {\im {\tau_1}} E : \im {\tau_1 \to \tau_2} $$

\rulename{(TrApp)} $ \Gamma \turns \App {e_1} {e_2} : \tau_2 \yields {E_1 (\App C {E_2})} $ \\

From \rulename{(TrApp)} we have
  $$ \Gamma \turns \tau_3 <: \tau_1 \yields C $$
Applying Lemma \ref{type-coerce} to the above we have
  $$ \im \Gamma \turns C : \im {\tau_3} \to \im {\tau_1} $$
Also from \rulename{(TrApp)} and the induction hypothesis
  $$ \im \Gamma \turns E_1 : \im {\tau_1} \to \im {\tau_2} $$
Also from \rulename{(TrApp)} and the induction hypothesis
  $$ \im \Gamma \turns E_2 : \im {\tau_3} $$
Assembling those parts using \rulename{(F-App)} we come to
  $$ \im \Gamma \turns E_1 (\App C {E_2}) : \im {\tau_2} $$
\end{proof}

\rulename{TAbs} $ \Gamma \turns \Lambda \alpha. e : \forall \alpha. \tau \yields {\forall \alpha. E} $ \\

From \rulename{TAbs} we have
  $$ \Gamma \turns e : \tau \yields E $$
By the induction hypothesis we have
  $$ \im \Gamma \turns E : \im \tau $$
Thus by \rulename{F-TAbs} and the definition of $ \im \cdot $
  $$ \Gamma \turns \Lambda \alpha. E : \im {\forall \alpha. \tau} $$


\rulename{TAp} $ \Gamma \turns e \; \tau  : \subst \tau \alpha  \tau_1 \yields {E \; \im \tau} $ \\

From \rulename{TApp} we have
  $$ \Gamma \turns e : \forall \alpha. \tau_1 \yields E $$
And by the induction hypothesis that
  $$ \im \Gamma \turns E : \forall \alpha. \im {\tau_1} $$
Also from \rulename{TApp} and Lemma \ref{preserve-wf} we have
  $$ \im \Gamma \turns \im \tau $$
Then by \rulename{F-TApp} that
  $$ \im \Gamma \turns E \; \im \tau : \subst {\im \tau} \alpha \im {\tau_1} $$
Therefore
  $$ \im \Gamma \turns E \; \im \tau : \im {\subst \tau \alpha \im {\tau_1}} $$

% \rulename{(TrMerge)} $ \Gamma \turns e_1 \merge e_2 : \tau_1 \& \tau_2 % % \yields {\Pair {E1} {E2} $ \\

From \rulename{(TrMerge)} and the induction hypothesis we have
  $$ \im \Gamma \turns E_1 : \im {\tau_1} $$
and
  $$ \im \Gamma \turns E_2 : \im {\tau_2} $$
Hence by \rulename{F-Pair}
  $$ \im \Gamma \turns \Pair {E_1} {E_2} : \Pair {\im {\tau_1}} {\im {\tau_2}} $$
Hence by the definition of $ \im \cdot $
  $$ \im \Gamma \turns \Pair {E_1} {E_2} : \im {\tau_1 \& \tau_2} $$

\rulename{RecIntro} $ \Gamma \turns \RecCon l e : \RecTy l \tau \yields E $ \\

From \rulename{RcdIntro} we have
  $$ \Gamma \turns e : \tau \yields E $$
And by the induction hypothesis that
  $$ \im \Gamma \turns E : \im \tau $$
Thus by the definition of $ \im \cdot $
  $$ \im \Gamma \turns E : \im {\RecTy l \tau} $$

\rulename{RcdElim} $ \Gamma \turns e.l : \tau_1 \yields {\App C E} $ \\

From \rulename{RcdElim}
  $$ \Gamma \turns e : \tau \yields E $$
And by the induction hypothesis that
  $$ \im \Gamma \turns E : \im \tau $$
Also from \rulename{RcdEim}
  $$ \Gamma \turnsget e ; l = C ; \tau_1 $$
Applying Lemma \ref{type-get} to the above we have
  $$ \im \Gamma \turns C : \im \tau \to \im {\tau_1}  $$
Hence by \rulename{F-App} we have
  $$ \im \Gamma \turns \App C E : \im {\tau_1} $$

From \rulename{RcdUpd}
  $$ \Gamma \turns e : \tau \yields E $$
And by the induction hypothesis that
  $$ \im \Gamma \turns E : \im \tau $$
Also from \rulename{RcdUpd}
  $$ \Gamma \turnsput \tau ; l; E = C ; \tau_1 $$
Applying Lemma \ref{type-put} to the above we have
  $$ \im \Gamma \turns C : \im \tau \to \im \tau  $$
Hence by \rulename{F-App} we have
  $$ \im \Gamma \turns \App C E : \im \tau $$
